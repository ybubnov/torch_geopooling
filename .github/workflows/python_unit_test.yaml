name: Python Unit Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    runs-on: ubuntu-latest
    container:
      image: python:${{matrix.python-version}}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Configure apt to disable recommendations installation
      run: |
        echo 'APT::Install-Recommends "false";' >> /etc/apt/apt.conf
        echo 'APT::Install-Suggests "false";' >> /etc/apt/apt.conf

    - name: Install third-party libraries and tools
      run: |
        apt-get update
        apt-get install -y cmake build-essential libboost-test-dev libfmt-dev wget unzip

    - name: Check Python version
      run: python --version

    - name: Install Python dependencies
      run: |
        pip install 'torch>=2.2.0+cpu' --index-url https://download.pytorch.org/whl/cpu
        pip install numpy pytest

    - name: Build and install
      run: |
        python setup.py build
        find "${{github.workspace}}" -name '_C.*.so' "${{github.workspace}}/torch_geopooling/" \;

    - name: Run unit-tests
      run: pytest -vv
