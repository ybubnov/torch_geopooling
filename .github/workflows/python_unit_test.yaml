name: Python Unit Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install pre-commit
        run: pip install pre-commit
      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure --color=always


  unit-tests:
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    runs-on: ubuntu-latest
    container:
      image: python:${{matrix.python-version}}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4

    - name: Configure apt to disable recommendations installation
      run: |
        echo 'APT::Install-Recommends "false";' >> /etc/apt/apt.conf
        echo 'APT::Install-Suggests "false";' >> /etc/apt/apt.conf

    - name: Install third-party libraries and tools
      run: |
        apt-get update
        apt-get install -y cmake build-essential libboost-test-dev libfmt-dev wget unzip

    - name: Check Python version
      run: python --version

    - name: Install Python dependencies
      run: |
        pip install 'torch>=2.2.0+cpu' --index-url https://download.pytorch.org/whl/cpu
        pip install numpy pytest

    - name: Build and install
      run: |
        python setup.py build
        find build -name '_C.*.so' -exec cp '{}' torch_geopooling/ \;

    - name: Run unit-tests
      run: pytest -vv
